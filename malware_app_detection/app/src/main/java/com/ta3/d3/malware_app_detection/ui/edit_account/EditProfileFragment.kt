 package com.ta3.d3.malware_app_detection.ui.edit_account

import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import androidx.fragment.app.Fragment
import androidx.fragment.app.activityViewModels
import androidx.navigation.fragment.findNavController
import com.ta3.d3.malware_app_detection.MyActivityViewModel
import com.ta3.d3.malware_app_detection.R
import com.ta3.d3.malware_app_detection.databinding.FragmentEditProfileBinding
import com.ta3.d3.malware_app_detection.db.AppDatabase
import com.ta3.d3.malware_app_detection.db.entities.User
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext


 class EditProfileFragment : Fragment() {
   private var _binding : FragmentEditProfileBinding? = null

  private val binding get() = _binding!!

  private val model : MyActivityViewModel by activityViewModels()
  val db by lazy { activity?.let { AppDatabase(it.applicationContext) } }

  var user: User? = null
  override fun onCreateView(
   inflater: LayoutInflater,
   container: ViewGroup?,
   savedInstanceState: Bundle?
  ): View? {

   _binding = FragmentEditProfileBinding.inflate(inflater, container, false)
   CoroutineScope(Dispatchers.IO).launch {
    user = db!!.userDao().loadAllByIds(intArrayOf(1))[0]
    print(user!!.name)
    withContext(Dispatchers.Main){
     binding.etEmail.setText(user!!.email)
     binding.etName.setText(user!!.name)
     binding.etPhoneNumber.setText(user!!.phoneNumber)
    }
   }

   binding.btnEdit.setOnClickListener {
    user!!.name = binding.etName.text.toString()
    user!!.email = binding.etEmail.text.toString()
    user!!.phoneNumber = binding.etPhoneNumber.text.toString()

    CoroutineScope(Dispatchers.IO).launch {
     db!!.userDao().update(user!!)
     withContext(Dispatchers.Main){
      findNavController().navigate(R.id.action_editProfileFragment_to_navigation_account)
     }
    }
   }
   return binding.root
  }
}